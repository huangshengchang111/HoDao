<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    {% include 'header.html' %}
  </head>
  <body>

{% include 'nav.html' %}

<div class="container">

    <h1 class="white-font">Ho单列表</h1>
    <div class="table-responsive"  style="background-color: #FFF" >


    <table class="table" style="background-color: #FFF">
        <thead>
            <tr>
                <th>日期</th><th>快递</th><th>姓名</th><th>电话</th>
                <th>修改Ho单</th>
                <th>创建时间</th><th>处理时间</th>
            </tr>
        </thead>
        <tbody>

        {% set order_class_mapping = {
                    0: "btn-warning",
                    1: "btn-primary",
                    2: "btn-primary",
                    3: "btn-success",
                    4: "btn-danger",
                    5: "btn-danger",
                }
        %}

        {% for order in sorted_orders %}
            <tr
            {% if order.status in [3, 4] %}
                    class="hd-finished-order"
            {% endif %}
            >
                {% if date_split[loop.index0]  %}
                    <td rowspan="{{ date_split[loop.index0] }}">{{ order.created_time.strftime('%Y-%m-%d') }}</td>
                {% endif %}
                {% if company_split[loop.index0]  %}
                    <td rowspan="{{ company_split[loop.index0] }}">{{ order.company }}</td>
                {% endif %}
                <td>{{ order.name }}</td>
                <td>{{ order.phone }}</td>

                <td>
                    {% for ix, v in order_status_mapping.items()|sort %}

                        <button id="order_{{ order.id }}_{{ ix }}"
                                onclick="submitUpdateOrder('{{ order.id }}', {{ ix }});"
                        {% if ix == order.status %}
                                disabled class="btn btn-xs {{ order_class_mapping[order.status] }}"
                        {% else %}
                                class="btn btn-xs btn-default"
                        {% endif%}
                        >
                            {{ v }}
                        </button>

                    {% endfor %}
                </td>

                <td>{{ order.created_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                <td>{{ order.modified_time.strftime('%Y-%m-%d %H:%M:%S') }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    </div>
</div>


    <script src="//lib.sinaapp.com/js/jquery/1.7.2/jquery.min.js"></script>
    <script>
        function submitUpdateOrder(order_id, status){
          $.post("/ajax/order/update",
                 {order_id: order_id, status: status, _csrf_token: "{{ csrf_token() }}"},
                 function (data, textStatus){

                if (data.status != 0) {
                    alert("update error!");
                    return;
                }

                var status_class_mapping = {{ order_class_mapping|safe }};

                var this_button_id = '#order_' + order_id + '_' + status;
                var this_button = $(this_button_id);
                this_button.removeClass("btn-default").addClass(status_class_mapping[status]);
                this_button.attr("disabled", true);

                var sbs = this_button.siblings();
                for (var i=0; i<sbs.length; i++) {
                    if (sbs[i].disabled) {
                        sbs[i].disabled = false;
                       // alert(i + "#" + status_class_mapping[i]);
                        $(sbs[i]).removeClass("btn-success btn-primary").addClass("btn-default");
                    }
                }



          })
        };
    </script>

  {% include 'footer.html' %}
  </body>
</html>
